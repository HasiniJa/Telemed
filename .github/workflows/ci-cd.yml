name: Telemed CI/CD Pipeline

on:
  push:
    branches: ["main"]

jobs:
  build-test-deploy:
    runs-on: self-hosted   # your self-hosted Windows runner
    env:
      MINIKUBE_REGISTRY: localhost:5000

    steps:
      # 1️. Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️.Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      # 3️. Build, Test, Deploy
      - name: Build, Test, Deploy Microservices
        shell: pwsh
        run: |
          $services = @("appointment", "patient", "notification")

          foreach ($service in $services) {
              Write-Host "======================================"
              Write-Host "Processing $service service..."
              Write-Host "======================================"

              # Go to service folder
              Set-Location $service

              # Install dependencies
              Write-Host "Installing dependencies for $service..."
              npm install

              # Run tests
              Write-Host "Running tests for $service..."
              npm test

              # Return to root
              Set-Location ..

              # Build Docker image
              Write-Host "Building Docker image for $service..."
              docker build -t $env:MINIKUBE_REGISTRY/$service-service:latest .\$service

              # Push Docker image
              Write-Host "Pushing Docker image for $service..."
              docker push $env:MINIKUBE_REGISTRY/$service-service:latest

              # Update Kubernetes deployment manifest with new image
              Write-Host "Updating Kubernetes manifest for $service..."
              (Get-Content "k8s\$service\deployment.yaml") -replace 'image:.*', "image: $env:MINIKUBE_REGISTRY/$service-service:latest" | Set-Content "k8s\$service\deployment.yaml"

              # Deploy to Kubernetes
              Write-Host "Deploying $service to Kubernetes..."
              kubectl apply -f "k8s\$service\deployment.yaml"
              kubectl apply -f "k8s\$service\service.yaml"

              # Wait for rollout
              Write-Host "Waiting for $service deployment rollout..."
              kubectl rollout status deployment/$service-deployment --timeout=120s
          }

      # 4️. Verify deployments (optional)
      - name: Verify deployments
        shell: pwsh
        run: |
          Write-Host "Pods in cluster:"
          kubectl get pods
          Write-Host "Services in cluster:"
          kubectl get svc
